name: IPé‡‡é›†æ£€æµ‹

on:
  schedule:
    - cron: '5 0 * * *'  # UTCæ—¶é—´æ¯å¤©0:05è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8:05ï¼‰
  workflow_dispatch:
    inputs:
      branch:
        description: 'main'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç  ğŸ“¥
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: è®¾ç½®Pythonç¯å¢ƒ ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: å®‰è£…ä¾èµ– ğŸ“¦
        run: |
          pip install --upgrade pip
          pip install selenium requests futures pyautogui eventlet opencv-python Beautifulsoup4 translate termcolor func_timeout replace input opencc pypinyin pytz tqdm

      - name: æ‰§è¡Œé‡‡é›†è„šæœ¬ ğŸš€
        run: |
          # åªä¿ç•™éœ€è¦æ‰§è¡Œçš„è„šæœ¬
          python ${{ github.workspace }}/py/æµ‹ç»˜ç«™é‡‡é›†.py
          # å…¶ä»–è„šæœ¬æŒ‰éœ€å–æ¶ˆæ³¨é‡Š

      - name: æäº¤å˜æ›´ ğŸ’¾
        run: |
          # é…ç½®Gitèº«ä»½
          git config --local user.email "actions@163.com"
          git config --local user.name "GitHub Action Bot"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          # æ‰§è¡Œæäº¤æ“ä½œ
          git add .
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°é‡‡é›†æ•°æ® [skip ci]"
          
          # å…ˆæ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
          git pull origin main --rebase
          
          # å¼ºåˆ¶æ¨é€æ›´æ–°ï¼ˆé€‚ç”¨äºè‡ªåŠ¨åŒ–åœºæ™¯ï¼‰
          git push origin main --force-with-lease

        # æ·»åŠ é”™è¯¯å¿½ç•¥ä»¥é˜²ç©ºæäº¤
        continue-on-error: true
